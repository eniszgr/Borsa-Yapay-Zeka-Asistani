import torch
import torch.nn as nn
import torch.optim as optim
import pandas as pd
from sklearn.preprocessing import MinMaxScaler
import numpy as np
import warnings

warnings.filterwarnings("ignore")

class deeplearning:
    def __init__(self):
        self.model=nn.Sequential(nn.Linear(6,32),
                                 nn.ReLU(),
                                 nn.Linear(32,1)
                                 )
    
    def analiz_et(self,df):
        if df is None or df.empty:
                return {"yön": "VERİ YOK", "güven": "0"}
        data=df.copy()

        df['Getiri'] = df['Close'].pct_change()
        df['Hacim_degisimi'] = df['Volume'].pct_change()
        df['Oynaklık'] = (df['High'] - df['Low']) / df['Close']

        #macd
        exp1 = df['Close'].ewm(span=12, adjust=False).mean()
        exp2 = df['Close'].ewm(span=26, adjust=False).mean()
        df['MACD'] = exp1 - exp2
        df['Signal_Line'] = df['MACD'].ewm(span=9, adjust=False).mean()
        df['MACD_Fark'] = df['MACD'] - df['Signal_Line'] # Histogram
        
        # RSI
        delta = df['Close'].diff()
        gain = (delta.where(delta > 0, 0))
        lose = (-delta.where(delta < 0, 0))
        avg_gain = gain.ewm(com=13, adjust=False).mean()
        avg_lose = lose.ewm(com=13, adjust=False).mean()
        rs = avg_gain / avg_lose
        df['RSI'] = 100 - (100 / (1 + rs))
        
        #bollinger
        df['SMA_20'] = df['Close'].rolling(window=20).mean()
        df['STD_20'] = df['Close'].rolling(window=20).std()
        df['Bollinger_Upper'] = df['SMA_20'] + (df['STD_20'] * 2)
        df['Bollinger_Lower'] = df['SMA_20'] - (df['STD_20'] * 2)
        df['Bollinger_Konum'] = (df['Close'] - df['Bollinger_Lower']) / (df['Bollinger_Upper'] - df['Bollinger_Lower'])
        
        #SMA_50,SMA_200
        df['SMA_50'] = df['Close'] / df['Close'].rolling(window=50).mean()
        df['SMA_200'] = df['Close'] / df['Close'].rolling(window=200).mean()
        
        features_to_lag = ['Getiri', 'RSI', 'Hacim_degisimi', 'MACD_Fark']
        for feature in features_to_lag:
            df[f'{feature}_Lag1'] = df[feature].shift(1)
            df[f'{feature}_Lag2'] = df[feature].shift(2)
        
        df['Gun'] = df.index.dayofweek
        df['Momentum'] = df['Close'] / df['Close'].shift(10)

        df['Target']=df['Close'].shift(-1)
        
        features = ['Close', 'RSI', 'MACD', 'Bollinger_Konum', 'Hacim_degisimi', 'Momentum']

        df = df.replace([np.inf, -np.inf], np.nan)
        son_gün_verisi=df[features].iloc[[-1]].values

        df_clean=df.dropna(subset=features+['Target'])
        
        if df_clean.empty:
             return {"yön": "YETERSİZ VERİ", "güven": "0", "suanki_fiyat": 0, "tahmin": 0}


        x_data=df_clean[features].values
        y_data=df_clean[['Target']].values

        x_scaler=MinMaxScaler()
        y_scaler=MinMaxScaler()
        
        x_scaled=x_scaler.fit_transform(x_data)
        y_scaled=y_scaler.fit_transform(y_data)

        x=torch.tensor(x_scaled,dtype=torch.float32)
        y=torch.tensor(y_scaled,dtype=torch.float32)
        
        hata=nn.MSELoss()
        optime=optim.Adam(self.model.parameters(), lr=0.005)

        for epoch in range(1000):
            optime.zero_grad()

            y_pred=self.model(x)
            loss=hata(y_pred,y)
            
            loss.backward()

            optime.step()

        son_gün=x_scaler.transform(son_gün_verisi)
        son_gün_tensor=torch.tensor(son_gün,dtype=torch.float32)
        
        sonuc=self.model(son_gün_tensor)
        sonuc=y_scaler.inverse_transform(sonuc.detach().numpy())

        suanki_fiyat = data['Close'].iloc[-1]
        tahmin_fiyat = sonuc[0][0]
        guven = max(0, min(100, int(100 - abs(tahmin_fiyat - suanki_fiyat) / suanki_fiyat * 100)))
        yon = "YÜKSELİŞ" if tahmin_fiyat > suanki_fiyat else "DÜŞÜŞ"

        return {
            "suanki_fiyat": round(suanki_fiyat, 2),
            "tahmin": round(tahmin_fiyat, 2),
            "güven": guven,
            "yön": yon
        }
        
        